# Lengthwords.top 服务器管理指南

> **域名**: `https://lengthwords.top`  
> **服务器**: 阿里云 ECS (CentOS 7)  
> **部署日期**: 2025-08-26  

---

## 🚀 快速状态检查

```bash
# 检查服务状态
sudo systemctl status lengthwords

# 测试API是否正常
curl -k https://lengthwords.top/api/test

# 查看端口监听
netstat -tlnp | grep :443
netstat -tlnp | grep :80
```

---

## 🔧 服务管理命令

### 基本服务控制
```bash
# 查看服务状态
sudo systemctl status lengthwords

# 重启服务
sudo systemctl restart lengthwords

# 停止服务
sudo systemctl stop lengthwords

# 启动服务
sudo systemctl start lengthwords

# 重新加载服务配置
sudo systemctl daemon-reload
```

### 日志查看
```bash
# 查看实时日志
sudo journalctl -u lengthwords -f

# 查看最近50行日志
sudo journalctl -u lengthwords --lines 50

# 查看今天的日志
sudo journalctl -u lengthwords --since today

# 查看错误日志
sudo journalctl -u lengthwords -p err
```

---

## 📋 重要文件路径

| 文件类型 | 路径 | 说明 |
|---------|------|------|
| 主服务文件 | `/opt/lengthwords/start-sudo.js` | Node.js 主程序 |
| SSL证书 | `/opt/lengthwords/lengthwords.top.pem` | HTTPS 证书 |
| SSL密钥 | `/opt/lengthwords/lengthwords.top.key` | HTTPS 私钥 |
| 数据文件 | `/opt/lengthwords/data.json` | 用户和学习数据 |
| 系统服务 | `/etc/systemd/system/lengthwords.service` | 系统服务配置 |
| 日志目录 | `/opt/lengthwords/logs/` | PM2 日志（如果使用） |

---

## 🛠️ 代码修改流程

### 1. 修改API代码
```bash
# 编辑主服务文件
sudo nano /opt/lengthwords/start-sudo.js

# 保存并退出后，重启服务
sudo systemctl restart lengthwords

# 查看启动日志确认无错误
sudo journalctl -u lengthwords --lines 20
```

### 2. 备份重要文件
```bash
# 备份主程序
sudo cp /opt/lengthwords/start-sudo.js /opt/lengthwords/start-sudo.js.backup

# 备份数据文件
sudo cp /opt/lengthwords/data.json /opt/lengthwords/data.json.backup

# 查看备份
ls -la /opt/lengthwords/*.backup
```

---

## 🧪 测试命令

### API 接口测试
```bash
# 测试基本接口
curl -k https://lengthwords.top/api/test

# 测试用户注册
curl -k -X POST https://lengthwords.top/api/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"123456"}'

# 测试用户登录
curl -k -X POST https://lengthwords.top/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"123456"}'

# 测试HTTP重定向
curl -I http://lengthwords.top/api/test
```

### 本地测试
```bash
# 本地回环测试
curl -k https://127.0.0.1/api/test

# 内网IP测试
curl -k https://172.24.214.5/api/test

# 公网IP测试
curl -k https://114.55.54.231/api/test
```

---

## 📊 数据管理

### 查看数据
```bash
# 查看所有数据（格式化）
cat /opt/lengthwords/data.json | python -m json.tool

# 查看用户数量
cat /opt/lengthwords/data.json | grep -o '"username"' | wc -l

# 查看数据文件大小
ls -lh /opt/lengthwords/data.json
```

### 数据备份
```bash
# 创建带时间戳的备份
sudo cp /opt/lengthwords/data.json /opt/lengthwords/data-$(date +%Y%m%d-%H%M%S).json

# 查看所有备份
ls -la /opt/lengthwords/data-*.json
```

---

## 🔒 SSL 证书管理

### 查看证书信息
```bash
# 查看证书有效期
openssl x509 -in /opt/lengthwords/lengthwords.top.pem -noout -dates

# 查看证书详细信息
openssl x509 -in /opt/lengthwords/lengthwords.top.pem -text -noout

# 验证证书和私钥匹配
openssl rsa -in /opt/lengthwords/lengthwords.top.key -modulus -noout | openssl md5
openssl x509 -in /opt/lengthwords/lengthwords.top.pem -modulus -noout | openssl md5
```

### 更新证书
```bash
# 上传新证书后，重启服务
sudo systemctl restart lengthwords

# 测试新证书
curl -k https://lengthwords.top/api/test
```

---

## 🚨 故障排除

### 服务无法启动
```bash
# 1. 查看详细错误
sudo journalctl -u lengthwords --lines 50

# 2. 检查文件权限
ls -la /opt/lengthwords/

# 3. 手动运行测试
sudo node /opt/lengthwords/start-sudo.js

# 4. 检查端口占用
netstat -tlnp | grep :443
```

### 域名无法访问
```bash
# 1. 检查服务状态
sudo systemctl status lengthwords

# 2. 测试本地访问
curl -k https://127.0.0.1/api/test

# 3. 检查DNS解析
nslookup lengthwords.top

# 4. 检查防火墙
sudo iptables -L | grep 443
```

### 数据丢失
```bash
# 1. 查找备份文件
find /opt/lengthwords/ -name "data*.json" -type f

# 2. 恢复最新备份
sudo cp /opt/lengthwords/data-YYYYMMDD-HHMMSS.json /opt/lengthwords/data.json

# 3. 重启服务
sudo systemctl restart lengthwords
```

---

## 📱 小程序配置

### 微信小程序后台设置
- **request 合法域名**: `https://lengthwords.top`
- **socket 合法域名**: `https://lengthwords.top`（如需要）
- **uploadFile 合法域名**: `https://lengthwords.top`（如需要）
- **downloadFile 合法域名**: `https://lengthwords.top`（如需要）

### API 接口列表
| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/test` | GET | 测试接口 |
| `/api/register` | POST | 用户注册 |
| `/api/login` | POST | 用户登录 |
| `/api/learning/stats` | GET | 学习统计（需认证） |
| `/api/learning/record` | POST | 记录学习（需认证） |

---

## ⚡ 性能监控

### 系统资源
```bash
# 查看CPU和内存使用
top -p $(pgrep -f "node.*start-sudo")

# 查看磁盘使用
df -h /opt/lengthwords/

# 查看网络连接
netstat -an | grep :443 | wc -l
```

### 日志分析
```bash
# 统计今日访问量
sudo journalctl -u lengthwords --since today | grep "GET\|POST" | wc -l

# 查看错误数量
sudo journalctl -u lengthwords --since today | grep -i error | wc -l
```

---

## 🔄 完全重新部署

如果需要从头开始：

```bash
# 1. 停止服务
sudo systemctl stop lengthwords
sudo systemctl disable lengthwords

# 2. 清理旧文件
sudo rm -f /etc/systemd/system/lengthwords.service
sudo systemctl daemon-reload

# 3. 重新创建服务
sudo systemctl enable lengthwords
sudo systemctl start lengthwords

# 4. 验证部署
curl -k https://lengthwords.top/api/test
```

---

## 📞 紧急联系

**服务器信息**:
- **公网IP**: 114.55.54.231
- **内网IP**: 172.24.214.5
- **实例ID**: i-bp13hqc58hbbk8qn3xee
- **地域**: 华东1(杭州)

**快速恢复命令**:
```bash
# 一键重启
sudo systemctl restart lengthwords && curl -k https://lengthwords.top/api/test
```

---

> **注意**: 所有命令都需要在服务器上以 root 用户执行。定期备份数据文件和配置文件。
